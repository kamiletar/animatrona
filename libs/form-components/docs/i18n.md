# i18n — Мультиязычность форм

Библиотека поддерживает полную мультиязычность: перевод labels, placeholders, описаний и **сообщений об ошибках валидации**.

## Содержание

- [Быстрый старт](#быстрый-старт)
- [FormI18nProvider](#formi18nprovider)
- [Перевод ошибок валидации](#перевод-ошибок-валидации)
- [Структура переводов](#структура-переводов)
- [Хуки](#хуки)
- [ZenStack интеграция](#zenstack-интеграция)
- [API Reference](#api-reference)

---

## Быстрый старт

```tsx
import { FormI18nProvider, Form } from '@lena/form-components'
import { useTranslations, useLocale } from 'next-intl'

function App({ children }) {
  const t = useTranslations('formSchemas')
  const locale = useLocale()

  return (
    <FormI18nProvider t={t} locale={locale} setupZodErrorMap>
      {children}
    </FormI18nProvider>
  )
}
```

**Что переводится:**
- `label` — из `i18nKey` + `.title`
- `placeholder` — из `i18nKey` + `.placeholder`
- `helperText` — из `i18nKey` + `.description`
- **Ошибки валидации** — из `validation.*` (v0.52.0+)

---

## FormI18nProvider

Провайдер для контекста переводов форм.

```tsx
<FormI18nProvider
  t={translateFunction}    // Функция перевода (совместима с next-intl)
  locale="ru"              // Текущая локаль
  setupZodErrorMap         // Включить перевод ошибок валидации
>
  {children}
</FormI18nProvider>
```

### Props

| Prop | Тип | Описание |
|------|-----|----------|
| `t` | `TranslateFunction` | Функция перевода `(key, params?) => string` |
| `locale` | `string` | Текущая локаль |
| `setupZodErrorMap` | `boolean` | Включить глобальный Zod error map с переводами |

### TranslateFunction

```typescript
type TranslateParams = Record<string, string | number | boolean | undefined>
type TranslateFunction = (key: string, params?: TranslateParams) => string
```

Совместима с `useTranslations` из `next-intl`.

---

## Перевод ошибок валидации

### Включение (v0.52.0+)

```tsx
<FormI18nProvider t={t} locale={locale} setupZodErrorMap>
  {/* Ошибки Zod автоматически переводятся */}
</FormI18nProvider>
```

### Как это работает

1. `setupZodErrorMap` устанавливает глобальный Zod error map через `z.config()`
2. При валидации Zod ищет перевод по ключу `validation.{code}.{origin}`
3. Если перевод найден — используется, иначе — дефолтное сообщение Zod

### Поддерживаемые ошибки

| Zod код | Ключ | Параметры | Пример |
|---------|------|-----------|--------|
| `too_small` | `validation.too_small.{string\|number\|array}` | `{minimum}` | Минимум {minimum} символов |
| `too_big` | `validation.too_big.{string\|number\|array}` | `{maximum}` | Максимум {maximum} символов |
| `invalid_format` | `validation.invalid_format.{email\|url\|uuid\|...}` | — | Некорректный email |
| `invalid_type` | `validation.invalid_type` | `{expected}` | Ожидался {expected} |
| `invalid_value` | `validation.invalid_value` | `{options}` | Ожидается: {options} |
| `unrecognized_keys` | `validation.unrecognized_keys` | `{keys}` | Неизвестные поля: {keys} |
| `not_multiple_of` | `validation.not_multiple_of` | `{multipleOf}` | Должно быть кратно {multipleOf} |
| `custom` | `validation.custom` | `{message}` | {message} |

### Примеры переводов

```json
{
  "validation": {
    "too_small": {
      "string": "Минимум {minimum} символов",
      "number": "Минимум {minimum}",
      "array": "Минимум {minimum} элементов"
    },
    "too_big": {
      "string": "Максимум {maximum} символов",
      "number": "Максимум {maximum}",
      "array": "Максимум {maximum} элементов"
    },
    "invalid_format": {
      "email": "Некорректный email",
      "url": "Некорректный URL",
      "uuid": "Некорректный UUID"
    },
    "invalid_type": "Неверный тип данных. Ожидался: {expected}",
    "invalid_value": "Недопустимое значение. Ожидается: {options}",
    "custom": "{message}"
  }
}
```

---

## Структура переводов

### Полная структура JSON

```json
{
  "Product": {
    "name": {
      "title": "Название товара",
      "placeholder": "Введите название",
      "description": "Название отображается в каталоге"
    },
    "price": {
      "title": "Цена",
      "placeholder": "0"
    }
  },
  "RecipeType": {
    "SWEET": { "label": "Сладкое" },
    "SALTY": { "label": "Солёное" }
  },
  "validation": {
    "too_small": {
      "string": "Минимум {minimum} символов",
      "number": "Минимум {minimum}"
    },
    "invalid_format": {
      "email": "Некорректный email"
    }
  }
}
```

### Приоритет

1. **Props** → `<Form.Field.String label="Своё" />`
2. **i18n** → `t('Product.name.title')`
3. **Schema meta** → `.meta({ ui: { title: 'Fallback' } })`

---

## Хуки

### useFormI18n

Доступ к контексту i18n:

```tsx
import { useFormI18n } from '@lena/form-components'

function CustomField() {
  const { t, locale, enabled } = useFormI18n()

  if (!enabled) return <DefaultField />

  const label = t('Product.name.title')
  return <Field label={label} />
}
```

### useLocalizedOptions

Перевод enum options:

```tsx
import { useLocalizedOptions } from '@lena/form-components'

function MySelect({ options }) {
  const localizedOptions = useLocalizedOptions(options)
  // Если у option есть i18nKey, label переводится автоматически

  return <Select options={localizedOptions} />
}
```

### getLocalizedValue

Утилита для получения переведённого значения:

```tsx
import { getLocalizedValue } from '@lena/form-components'

const label = getLocalizedValue(
  t,           // TranslateFunction
  'Product.name', // i18nKey
  'title',     // suffix
  'Fallback'   // fallback
)
```

---

## ZenStack интеграция

### Конфигурация плагина

```zmodel
plugin formSchemas {
  provider = '@lena/zenstack-form-plugin'
  output = 'src/generated/form-schemas'

  // i18n
  i18n = true
  i18nOutput = './messages/form-schemas'
  defaultLocale = 'ru'
  locales = 'ru,en'
}
```

### Генерируемые файлы

```
messages/form-schemas/
├── ru.json    # defaultLocale — перезаписывается
├── en.json    # merge-стратегия
└── keys.ts    # TypeScript типы
```

### Стратегии обновления

| Локаль | Стратегия | Поведение |
|--------|-----------|-----------|
| `defaultLocale` | Перезапись | Полностью перегенерируется |
| Другие | Merge | Новые ключи добавляются, существующие сохраняются |

---

## API Reference

### createFormErrorMap

Создаёт Zod error map для перевода ошибок:

```tsx
import { createFormErrorMap } from '@lena/form-components'
import { z } from 'zod/v4'

const errorMap = createFormErrorMap({
  t: translateFunction,
  prefix: 'validation'  // опционально, default: 'validation'
})

z.config({ customError: errorMap })
```

### ZOD_ERROR_CODES

Константа со всеми кодами ошибок Zod v4:

```tsx
import { ZOD_ERROR_CODES } from '@lena/form-components'

// ['invalid_type', 'too_small', 'too_big', 'invalid_format', ...]
```

### SIZE_ORIGINS

Origins для ошибок размера:

```tsx
import { SIZE_ORIGINS } from '@lena/form-components'

// ['string', 'number', 'array', 'date', 'set', 'file']
```

### STRING_FORMATS

Форматы для `invalid_format`:

```tsx
import { STRING_FORMATS } from '@lena/form-components'

// ['email', 'url', 'uuid', 'datetime', ...]
```

---

## Обратная совместимость

| Сценарий | Поведение |
|----------|-----------|
| Без `FormI18nProvider` | Используются значения из schema meta |
| `setupZodErrorMap: false` | Дефолтные сообщения Zod |
| Отсутствует перевод | Fallback к schema meta или ключу |
| Zod v4 | Полная поддержка (`invalid_format`, `invalid_value`) |

---

**Версия:** 0.52.0
**Последнее обновление:** 2026-01-03
