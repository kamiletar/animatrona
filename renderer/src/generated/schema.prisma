//////////////////////////////////////////////////////////////////////////////////////////////
// DO NOT MODIFY THIS FILE                                                                  //
// This file is automatically generated by ZenStack CLI and should not be manually updated. //
//////////////////////////////////////////////////////////////////////////////////////////////

datasource db {
    provider = "sqlite"
    url = "file:../../../prisma/data/app.db"
}

generator client {
    provider = "prisma-client-js"
    output = "./prisma"
    binaryTargets = ["native", "windows"]
}

enum AnimeStatus {
    /// Выходит
    ONGOING
    /// Завершён
    COMPLETED
    /// Анонсирован
    ANNOUNCED
}

/// Первоисточник аниме
enum AnimeSource {
    /// Манга
    MANGA
    /// Ранобэ / Light Novel
    LIGHT_NOVEL
    /// Оригинальный сценарий
    ORIGINAL
    /// Визуальная новелла
    VISUAL_NOVEL
    /// Видеоигра
    GAME
    /// Веб-манга
    WEB_MANGA
    /// Другое
    OTHER
}

/// Возрастной рейтинг
enum AgeRating {
    /// Для всех возрастов
    G
    /// Для детей от 7 лет
    PG
    /// Для подростков от 13 лет
    PG_13
    /// Для взрослых от 17 лет (насилие, откровенные сцены)
    R_17
    /// Для взрослых (более откровенный контент)
    R_PLUS
    /// Хентай (18+)
    RX
}

enum TranscodeStatus {
    /// В очереди
    QUEUED
    /// Транскодируется
    PROCESSING
    /// Готово
    COMPLETED
    /// Пропущено (AAC ≤ 256kbps, не нужно транскодировать)
    SKIPPED
    /// Ошибка
    ERROR
}

enum VideoCodec {
    /// AV1 (рекомендуется)
    AV1
    /// HEVC/H.265
    HEVC
    /// H.264
    H264
    /// Исходный кодек
    COPY
}

/// Предпочтения выбора дорожек при просмотре
enum TrackPreference {
    /// Русская озвучка + субтитры надписей
    RUSSIAN_DUB
    /// Оригинальная дорожка + полные субтитры
    ORIGINAL_SUB
    /// Автовыбор по доступности (русская если есть, иначе оригинал)
    AUTO
}

enum SeasonType {
    /// ТВ-сериал
    TV
    /// OVA
    OVA
    /// ONA
    ONA
    /// Фильм
    MOVIE
    /// Спешл
    SPECIAL
}

enum ChapterType {
    /// Обычная глава
    CHAPTER
    /// Опенинг
    OP
    /// Эндинг
    ED
    /// Рекап
    RECAP
    /// Превью
    PREVIEW
}

enum FileCategory {
    /// Постер аниме
    POSTER
    /// Скриншот эпизода
    SCREENSHOT
    /// Превью эпизода
    THUMBNAIL
    /// Шрифт субтитров
    FONT
}

enum RateControl {
    /// Variable Bitrate с CQ target (рекомендуется)
    VBR
    /// Constant QP (лучшее качество)
    CONSTQP
    /// Constant Quality
    CQ
}

enum Tune {
    /// Без tune
    NONE
    /// High Quality (рекомендуется для VBR)
    HQ
    /// Ultra High Quality (для Blackwell+)
    UHQ
    /// Ultra Low Latency
    ULL
    /// Low Latency
    LL
}

enum Multipass {
    /// Отключено
    DISABLED
    /// Quarter resolution (быстрее)
    QRES
    /// Full resolution (медленнее, лучше качество)
    FULLRES
}

enum BRefMode {
    /// Отключено
    DISABLED
    /// Каждый кадр
    EACH
    /// Средний кадр
    MIDDLE
}

enum RelationKind {
    /// Продолжение
    SEQUEL
    /// Предыстория
    PREQUEL
    /// Побочная история
    SIDE_STORY
    /// Родительская история
    PARENT_STORY
    /// Краткое содержание
    SUMMARY
    /// Полная версия
    FULL_STORY
    /// Спин-офф
    SPIN_OFF
    /// Адаптация
    ADAPTATION
    /// Общие персонажи
    CHARACTER
    /// Альтернативная версия
    ALTERNATIVE_VERSION
    /// Альтернативный сеттинг
    ALTERNATIVE_SETTING
    /// Другое
    OTHER
}

enum PersonRole {
    /// Режиссёр
    DIRECTOR
    /// Сценарист
    WRITER
    /// Автор оригинала
    ORIGINAL_CREATOR
    /// Дизайн персонажей
    CHARACTER_DESIGN
    /// Композитор
    MUSIC
    /// Продюсер
    PRODUCER
    /// Режиссёр анимации
    ANIMATION_DIRECTOR
    /// Главный аниматор
    KEY_ANIMATOR
    /// Арт-директор
    ART_DIRECTOR
    /// Звукорежиссёр
    SOUND_DIRECTOR
    /// Другое
    OTHER
}

enum ExternalLinkKind {
    /// MyAnimeList
    MYANIMELIST
    /// AniDB
    ANIDB
    /// AniList
    ANILIST
    /// Wikipedia
    WIKIPEDIA
    /// Официальный сайт
    OFFICIAL_SITE
    /// Twitter/X
    TWITTER
    /// World Art
    WORLDART
    /// КиноПоиск
    KINOPOISK
    /// Anime News Network
    ANIME_NEWS_NETWORK
    /// Другое
    OTHER
}

enum VideoKind {
    /// Опенинг
    OP
    /// Эндинг
    ED
    /// Промо-видео / Трейлер
    PV
    /// Рекламный ролик
    CM
    /// Клип
    CLIP
    /// Эпизод (отрывок)
    EPISODE_PREVIEW
    /// Другое
    OTHER
}

/// Статус просмотра аниме (как на Shikimori)
enum WatchStatus {
    /// Не начато
    NOT_STARTED
    /// Смотрю
    WATCHING
    /// Просмотрено
    COMPLETED
    /// Отложено
    ON_HOLD
    /// Брошено
    DROPPED
    /// Запланировано
    PLANNED
}

/// Статус элемента очереди импорта
enum ImportQueueItemStatus {
    /// Ожидает в очереди
    PENDING
    /// Подбор оптимального CQ через VMAF
    VMAF
    /// Подготовка (создание аниме, demux)
    PREPARING
    /// Транскодирование
    TRANSCODING
    /// Постобработка (скриншоты, манифесты)
    POSTPROCESS
    /// Завершён успешно
    COMPLETED
    /// Ошибка
    ERROR
    /// Отменён пользователем
    CANCELLED
}

/// Файл (изображения, шрифты и т.д.)
model File {
    id String @id() @default(cuid())
    /// Имя файла на диске
    filename String
    /// Полный путь к файлу
    path String @unique()
    /// MIME-тип (image/jpeg, image/webp, font/ttf)
    mimeType String
    /// Размер в байтах
    size Int
    /// Ширина в пикселях (для изображений)
    width Int?
    /// Высота в пикселях (для изображений)
    height Int?
    /// Base64 blur placeholder для next/image
    blurDataURL String?
    /// Категория файла
    category FileCategory
    /// Источник (например, "shikimori")
    source String?
    uploadedAt DateTime @default(now())
    animePoster Anime[]

    @@index([category])
    @@index([uploadedAt])
}

/// Франшиза — группа связанных аниме
/// Определяется через REST API /api/animes/{id}/franchise
/// Все аниме в одном графе = одна франшиза
model Franchise {
    id String @id() @default(cuid())
    /// Название франшизы (от root аниме)
    name String
    /// @deprecated Ненадёжный ID из GraphQL — использовать rootShikimoriId
    /// Оставлено для обратной совместимости
    shikimoriFranchiseId String? @unique()
    /// Минимальный shikimoriId из графа — стабильный ключ франшизы
    rootShikimoriId Int? @unique()
    /// Полный граф франшизы в JSON (nodes + links из REST API)
    graphJson String?
    /// Когда граф был обновлён (для автообновления раз в неделю)
    graphUpdatedAt DateTime?
    animes Anime[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()

    @@index([rootShikimoriId])
}

/// Аниме-тайтл
model Anime {
    id String @id() @default(cuid())
    /// @form.title("Название")
    /// @form.placeholder("Например: Стальной алхимик")
    /// Русское название (приоритет) или английское если русского нет
    name String
    /// @form.title("Оригинальное название")
    /// @form.placeholder("Например: 鋼の錬金術師")
    /// Японское название (из Shikimori japanese)
    originalName String?
    /// @form.exclude
    /// Английское название (из Shikimori english)
    nameEn String?
    /// @form.exclude
    /// Альтернативные названия (JSON массив строк с Shikimori)
    /// Например: ["Человек-бензопила", "История Резе", "Gekijouban Chainsaw Man"]
    synonyms String?
    /// @form.title("Год выпуска")
    /// @form.fieldType("numberInput")
    /// @form.props({ min: 1900, max: 2100 })
    year Int?
    /// @form.title("Статус")
    /// @form.fieldType("radioCard")
    status AnimeStatus @default(ONGOING)
    /// @form.title("Количество серий")
    /// @form.fieldType("numberInput")
    /// @form.props({ min: 0 })
    episodeCount Int @default(0)
    /// @form.title("Описание")
    /// @form.fieldType("textarea")
    description String?
    /// @form.exclude
    /// Постер аниме (связь с File)
    posterId String?
    poster File? @relation(fields: [posterId], references: [id], onDelete: SetNull)
    /// @form.title("Рейтинг")
    /// @form.fieldType("slider")
    /// @form.props({ min: 0, max: 10, step: 0.1, showValue: true })
    rating Float?
    /// @form.exclude
    /// Первоисточник (Манга, Ранобэ, Оригинал и т.д.)
    source AnimeSource?
    /// @form.exclude
    /// Возрастной рейтинг (G, PG, PG-13, R-17 и т.д.)
    ageRating AgeRating?
    /// @form.exclude
    /// Длительность эпизода в минутах
    duration Int?
    /// @form.exclude
    /// Лицензиат в РФ (название компании)
    licensor String?
    /// @form.title("Путь к папке")
    /// @form.description("Путь к папке с файлами аниме")
    folderPath String?
    /// @form.exclude
    /// Источник — BDRemux/Bluray Remux (lossless качество)
    isBdRemux Boolean @default(false)
    /// @form.exclude
    /// ID на Shikimori для синхронизации метаданных
    shikimoriId Int? @unique()
    /// @form.exclude
    /// Франшиза к которой принадлежит аниме
    franchiseId String?
    franchise Franchise? @relation(fields: [franchiseId], references: [id], onDelete: SetNull)
    seasons Season[]
    episodes Episode[]
    genres GenreOnAnime[]
    themes ThemeOnAnime[]
    watchProgress WatchProgress[]
    /// Связи с другими аниме (это аниме как источник)
    sourceRelations AnimeRelation[] @relation("SourceRelations")
    /// Связи с другими аниме (это аниме как цель)
    targetRelations AnimeRelation[] @relation("TargetRelations")
    /// Студии анимации
    studios StudioOnAnime[]
    /// Персоны (режиссёры, сценаристы и т.д.)
    staff PersonOnAnime[]
    /// Персонажи
    characters CharacterOnAnime[]
    /// Внешние ссылки (MAL, AniDB и т.д.)
    externalLinks ExternalLink[]
    /// Команды озвучки
    fandubbers FandubberOnAnime[]
    /// Команды субтитров
    fansubbers FansubberOnAnime[]
    /// Видео (трейлеры, опенинги, эндинги) — v0.5.3
    videos Video[]
    /// @form.exclude
    /// Дата следующего эпизода (для онгоингов)
    nextEpisodeAt DateTime?
    /// @form.exclude
    /// Последняя выбранная аудиодорожка (dubGroup) — сохраняется между эпизодами
    lastSelectedAudioDubGroup String?
    /// @form.exclude
    /// Язык последней выбранной аудиодорожки — fallback если dubGroup не найден
    lastSelectedAudioLanguage String?
    /// @form.exclude
    /// Последняя выбранная дорожка субтитров (dubGroup) — сохраняется между эпизодами
    lastSelectedSubtitleDubGroup String?
    /// @form.exclude
    /// Язык последних выбранных субтитров — fallback если dubGroup не найден
    lastSelectedSubtitleLanguage String?
    /// @form.exclude
    /// Когда последний раз проверяли связи с другими аниме (для UX: null = не проверяли, дата = проверяли)
    relationsCheckedAt DateTime?
    /// @form.title("Статус просмотра")
    /// @form.fieldType("radioCard")
    watchStatus WatchStatus @default(NOT_STARTED)
    /// @form.exclude
    /// Дата завершения просмотра
    watchedAt DateTime?
    /// @form.title("Оценка")
    /// @form.fieldType("slider")
    /// @form.props({ min: 0, max: 10, step: 1, showValue: true })
    userRating Int?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()

    @@index([name])
    @@index([year])
    @@index([status])
    @@index([shikimoriId])
    @@index([franchiseId])
    @@index([watchStatus])
}

/// Жанр
model Genre {
    id String @id() @default(cuid())
    /// @form.title("Название")
    name String @unique()
    /// @form.title("Slug")
    slug String @unique()
    /// ID на Shikimori (для синхронизации)
    shikimoriId Int? @unique()
    animes GenreOnAnime[]
}

/// Студия анимации
model Studio {
    id String @id() @default(cuid())
    /// @form.title("Название")
    name String @unique()
    /// ID на Shikimori
    shikimoriId Int? @unique()
    /// URL логотипа студии
    imageUrl String?
    animes StudioOnAnime[]
    createdAt DateTime @default(now())

    @@index([name])
}

/// Связь студий и аниме (many-to-many)
model StudioOnAnime {
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    studio Studio @relation(fields: [studioId], references: [id], onDelete: Cascade)
    studioId String

    @@id([animeId, studioId])
}

/// Персона (режиссёр, сейю, аниматор и т.д.)
model Person {
    id String @id() @default(cuid())
    /// @form.title("Имя")
    name String
    /// Имя на русском
    nameRu String?
    /// ID на Shikimori
    shikimoriId Int? @unique()
    /// URL изображения
    imageUrl String?
    /// Роли в аниме
    animeRoles PersonOnAnime[]
    /// Озвученные персонажи
    voicedCharacters CharacterVoice[]
    createdAt DateTime @default(now())

    @@index([name])
    @@index([nameRu])
}

/// Связь персон с аниме (режиссёры, сценаристы и т.д.)
model PersonOnAnime {
    id String @id() @default(cuid())
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    person Person @relation(fields: [personId], references: [id], onDelete: Cascade)
    personId String
    /// Роль в проекте
    role PersonRole
    /// Текст роли (оригинальный из API)
    roleText String?

    @@unique([animeId, personId, role])
    @@index([animeId])
    @@index([personId])
    @@index([role])
}

/// Персонаж аниме
model Character {
    id String @id() @default(cuid())
    /// @form.title("Имя")
    name String
    /// Имя на русском
    nameRu String?
    /// ID на Shikimori
    shikimoriId Int? @unique()
    /// URL изображения
    imageUrl String?
    /// В каких аниме появляется
    animeAppearances CharacterOnAnime[]
    /// Кто озвучивает
    voices CharacterVoice[]
    createdAt DateTime @default(now())

    @@index([name])
    @@index([nameRu])
}

/// Связь персонажей с аниме
model CharacterOnAnime {
    id String @id() @default(cuid())
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId String
    /// Роль (главный/второстепенный)
    roleText String?

    @@unique([animeId, characterId])
    @@index([animeId])
    @@index([characterId])
}

/// Связь персонажа с сейю (кто озвучивает)
model CharacterVoice {
    id String @id() @default(cuid())
    character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId String
    person Person @relation(fields: [personId], references: [id], onDelete: Cascade)
    personId String
    /// ID аниме (для контекста, один сейю может озвучивать в разных аниме)
    animeId String?

    @@unique([characterId, personId, animeId])
    @@index([characterId])
    @@index([personId])
}

/// Внешняя ссылка (MAL, AniDB, официальный сайт)
model ExternalLink {
    id String @id() @default(cuid())
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    /// Тип ссылки
    kind ExternalLinkKind
    /// URL
    url String
    /// ID на Shikimori
    shikimoriId Int?
    createdAt DateTime @default(now())

    @@unique([animeId, kind])
    @@index([animeId])
}

/// Видео (трейлеры, опенинги, эндинги) — v0.5.3
model Video {
    id String @id() @default(cuid())
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    /// ID видео на Shikimori
    shikimoriId Int? @unique()
    /// Название видео
    name String?
    /// Тип видео (OP, ED, PV, CM и т.д.)
    kind VideoKind @default(OTHER)
    /// URL видео (обычно YouTube)
    url String
    /// URL для embed плеера (YouTube embed)
    playerUrl String?
    /// URL превью изображения
    imageUrl String?
    /// Хостинг видео (youtube, vk, etc.)
    hosting String?
    createdAt DateTime @default(now())

    @@index([animeId])
    @@index([kind])
}

/// Команда озвучки (fandub)
model Fandubber {
    id String @id() @default(cuid())
    /// @form.title("Название")
    name String @unique()
    animes FandubberOnAnime[]
}

/// Связь команд озвучки с аниме
model FandubberOnAnime {
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    fandubber Fandubber @relation(fields: [fandubberId], references: [id], onDelete: Cascade)
    fandubberId String

    @@id([animeId, fandubberId])
}

/// Команда субтитров (fansub)
model Fansubber {
    id String @id() @default(cuid())
    /// @form.title("Название")
    name String @unique()
    animes FansubberOnAnime[]
}

/// Связь команд субтитров с аниме
model FansubberOnAnime {
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    fansubber Fansubber @relation(fields: [fansubberId], references: [id], onDelete: Cascade)
    fansubberId String

    @@id([animeId, fansubberId])
}

/// Связь жанров и аниме (many-to-many)
model GenreOnAnime {
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    genre Genre @relation(fields: [genreId], references: [id], onDelete: Cascade)
    genreId String

    @@id([animeId, genreId])
}

/// Тема аниме (Жестокость, Городское фэнтези, Школа и т.д.)
model Theme {
    id String @id() @default(cuid())
    /// @form.title("Название")
    name String @unique()
    /// Название на русском (из Shikimori)
    nameRu String?
    /// ID на Shikimori (для синхронизации)
    shikimoriId Int? @unique()
    animes ThemeOnAnime[]

    @@index([name])
}

model ThemeOnAnime {
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    theme Theme @relation(fields: [themeId], references: [id], onDelete: Cascade)
    themeId String

    @@id([animeId, themeId])
}

/// Связь между двумя аниме (сиквел, приквел, спин-офф и т.д.)
model AnimeRelation {
    id String @id() @default(cuid())
    /// Исходное аниме (от которого идёт связь)
    sourceAnimeId String
    sourceAnime Anime @relation("SourceRelations", fields: [sourceAnimeId], references: [id], onDelete: Cascade)
    /// ID связанного аниме на Shikimori (может быть не загружено в библиотеку)
    targetShikimoriId Int
    /// ID связанного аниме в библиотеке (заполняется когда аниме загружено)
    targetAnimeId String?
    targetAnime Anime? @relation("TargetRelations", fields: [targetAnimeId], references: [id], onDelete: SetNull)
    /// Тип связи
    relationKind RelationKind
    /// Название связанного аниме
    targetName String?
    /// URL постера связанного аниме
    targetPosterUrl String?
    /// Год выпуска связанного аниме
    targetYear Int?
    /// Тип аниме (tv, movie, ova, etc.)
    targetKind String?
    createdAt DateTime @default(now())

    @@unique([sourceAnimeId, targetShikimoriId])
    @@index([sourceAnimeId])
    @@index([targetAnimeId])
    @@index([targetShikimoriId])
}

/// Сезон аниме (TV, OVA, Movie и т.д.)
model Season {
    id String @id() @default(cuid())
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    /// @form.title("Номер сезона")
    /// @form.fieldType("numberInput")
    /// @form.props({ min: 1 })
    number Int @default(1)
    /// @form.title("Название")
    /// @form.placeholder("Например: 2nd Season")
    name String?
    /// @form.title("Тип")
    /// @form.fieldType("radioCard")
    type SeasonType @default(TV)
    /// @form.title("Год выпуска")
    /// @form.fieldType("numberInput")
    year Int?
    /// @form.title("Количество эпизодов")
    /// @form.fieldType("numberInput")
    episodeCount Int @default(0)
    /// @form.title("Путь к папке")
    folderPath String?
    episodes Episode[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()

    @@unique([animeId, number])
    @@index([animeId])
}

/// Аудиодорожка эпизода
model AudioTrack {
    id String @id() @default(cuid())
    episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
    episodeId String
    /// Индекс дорожки в контейнере
    streamIndex Int
    /// @form.title("Язык")
    /// @form.placeholder("ru, en, ja")
    language String @default("und")
    /// @form.title("Название")
    /// @form.placeholder("Например: Japanese 5.1")
    title String?
    /// Название группы озвучки (имя папки-дублёра)
    /// Отображается в меню плеера как "Русский (FuegoAlma & Eladiel)"
    dubGroup String?
    /// Кодек (aac, opus, flac, etc.)
    codec String
    /// Каналы (2.0, 5.1, 7.1)
    channels String
    /// Битрейт (bps)
    bitrate Int?
    /// Дорожка по умолчанию
    isDefault Boolean @default(false)
    /// Путь к извлечённому файлу (после demux)
    extractedPath String?
    /// Путь к транскодированному файлу (AAC) или к копии
    transcodedPath String?
    /// Статус транскодирования аудио
    transcodeStatus TranscodeStatus @default(QUEUED)
    /// Ошибка транскодирования
    transcodeError String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()

    @@index([episodeId])
}

/// Субтитры эпизода
model SubtitleTrack {
    id String @id() @default(cuid())
    episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
    episodeId String
    /// Индекс дорожки в контейнере (-1 для внешних файлов)
    streamIndex Int @default(-1)
    /// @form.title("Язык")
    language String @default("und")
    /// @form.title("Название")
    title String?
    /// Название группы субтитров (имя папки-сабберов)
    /// Отображается в меню плеера как "Русский (AniDUB)"
    dubGroup String?
    /// Формат (ass, srt, vtt)
    format String
    /// Путь к извлечённому файлу субтитров
    filePath String?
    /// Дорожка по умолчанию
    isDefault Boolean @default(false)
    /// Шрифты для ASS субтитров
    fonts SubtitleFont[]
    createdAt DateTime @default(now())

    @@index([episodeId])
}

/// Шрифт для ASS субтитров
model SubtitleFont {
    id String @id() @default(cuid())
    subtitleTrack SubtitleTrack @relation(fields: [subtitleTrackId], references: [id], onDelete: Cascade)
    subtitleTrackId String
    /// Имя шрифта (как в ASS файле)
    fontName String
    /// Путь к файлу шрифта
    filePath String
    createdAt DateTime @default(now())

    @@index([subtitleTrackId])
}

/// Глава эпизода (для навигации и автопропуска)
model Chapter {
    id String @id() @default(cuid())
    episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
    episodeId String
    /// Время начала (мс)
    startMs Int
    /// Время конца (мс)
    endMs Int
    /// @form.title("Название")
    title String?
    /// Тип главы
    type ChapterType @default(CHAPTER)
    /// Можно ли пропустить (для опенингов/эндингов)
    skippable Boolean @default(false)
    createdAt DateTime @default(now())

    @@index([episodeId])
    @@index([type])
}

/// Эпизод (серия)
model Episode {
    id String @id() @default(cuid())
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    season Season? @relation(fields: [seasonId], references: [id], onDelete: SetNull)
    seasonId String?
    /// @form.title("Номер серии")
    /// @form.fieldType("numberInput")
    /// @form.props({ min: 0 })
    number Int
    /// @form.title("Название")
    name String?
    /// @form.title("Длительность (мс)")
    /// @form.fieldType("numberInput")
    durationMs Int?
    /// @form.title("Путь к исходному файлу")
    sourcePath String?
    /// @form.title("Путь к транскодированному файлу")
    transcodedPath String?
    /// @form.exclude
    /// Путь к манифесту эпизода (JSON с метаданными для плеера)
    manifestPath String?
    /// @form.exclude
    /// Путь к извлечённому видео (после demux, без аудио)
    extractedVideoPath String?
    /// @form.title("Статус транскодирования")
    transcodeStatus TranscodeStatus @default(QUEUED)
    /// @form.exclude
    transcodeError String?
    /// @form.exclude
    videoCodec String?
    /// @form.exclude
    videoWidth Int?
    /// @form.exclude
    videoHeight Int?
    /// @form.exclude
    videoBitrate Int?
    /// @form.exclude
    /// Битность цвета видео (8, 10, 12)
    videoBitDepth Int?
    /// @form.exclude
    /// JSON массив путей к thumbnail-ам (320px для карточек)
    thumbnailPaths String?
    /// @form.exclude
    /// JSON массив путей к полноразмерным скриншотам (1280px для лайтбокса)
    screenshotPaths String?
    audioTracks AudioTrack[]
    subtitleTracks SubtitleTrack[]
    chapters Chapter[]
    watchProgress WatchProgress[]
    /// @form.exclude
    /// JSON с настройками кодирования (codec, cq, preset, etc.)
    encodingSettingsJson String?
    /// @form.exclude
    /// ID использованного профиля кодирования
    encodingProfileId String?
    encodingProfile EncodingProfile? @relation(fields: [encodingProfileId], references: [id], onDelete: SetNull)
    /// @form.exclude
    /// Размер исходного файла в байтах
    sourceSize BigInt?
    /// @form.exclude
    /// Размер транскодированного файла в байтах
    transcodedSize BigInt?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()

    @@unique([animeId, number])
    @@index([animeId])
    @@index([seasonId])
    @@index([transcodeStatus])
}

/// Прогресс просмотра
model WatchProgress {
    id String @id() @default(cuid())
    anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)
    animeId String
    episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
    episodeId String
    /// @form.title("Текущее время (сек)")
    currentTime Float @default(0)
    /// @form.title("Просмотрено полностью")
    /// @form.fieldType("switch")
    completed Boolean @default(false)
    /// ID выбранной аудиодорожки
    selectedAudioTrackId String?
    /// ID выбранных субтитров (null = выключены)
    selectedSubtitleTrackId String?
    /// Громкость (0-1)
    volume Float @default(1)
    lastWatchedAt DateTime @default(now())

    @@unique([animeId, episodeId])
    @@index([animeId])
    @@index([lastWatchedAt])
}

/// Настройки приложения (singleton)
model Settings {
    id String @id() @default("default")
    /// @form.title("Использовать GPU")
    /// @form.fieldType("switch")
    /// @form.description("Использовать NVIDIA NVENC для транскодирования")
    useGpu Boolean @default(true)
    /// @form.title("Видеокодек")
    /// @form.fieldType("radioCard")
    videoCodec VideoCodec @default(AV1)
    /// @form.title("Качество видео (CQ/CRF)")
    /// @form.fieldType("slider")
    /// @form.props({ min: 0, max: 51, showValue: true })
    /// @form.description("Меньше = лучше качество, больше размер")
    videoQuality Int @default(24)
    /// @form.title("Пресет скорости")
    /// @form.fieldType("select")
    /// @form.props({ options: ["p1", "p2", "p3", "p4", "p5", "p6", "p7"] })
    videoPreset String @default("p5")
    /// @form.title("Битрейт аудио (kbps)")
    /// @form.fieldType("slider")
    /// @form.props({ min: 64, max: 512, step: 32, showValue: true })
    audioBitrate Int @default(256)
    /// @form.title("Папка библиотеки")
    /// @form.description("Путь к папке с медиафайлами")
    libraryPath String?
    /// @form.title("Папка для транскодирования")
    /// @form.description("Куда сохранять перекодированные файлы")
    outputPath String?
    /// @form.title("Папка экспорта по умолчанию")
    /// @form.description("Куда сохранять MKV файлы при экспорте")
    exportPath String?
    /// @form.title("Сворачивать в трей")
    /// @form.fieldType("switch")
    /// @form.description("Приложение продолжит работать в фоне")
    minimizeToTray Boolean @default(true)
    /// @form.title("Закрытие окна в трей")
    /// @form.fieldType("switch")
    /// @form.description("При нажатии на крестик сворачивать в трей вместо закрытия")
    closeToTray Boolean @default(true)
    /// @form.title("Показывать уведомление при сворачивании")
    /// @form.fieldType("switch")
    /// @form.description("Показывать уведомление при первом сворачивании в трей")
    showTrayNotification Boolean @default(true)
    /// @form.title("Тёмная тема")
    /// @form.fieldType("switch")
    darkMode Boolean @default(true)
    /// @form.title("Язык интерфейса")
    /// @form.fieldType("select")
    /// @form.props({ options: ["ru", "en", "ja"] })
    language String @default("ru")
    /// @form.title("Автопропуск опенинга")
    /// @form.fieldType("switch")
    skipOpening Boolean @default(false)
    /// @form.title("Автопропуск эндинга")
    /// @form.fieldType("switch")
    skipEnding Boolean @default(false)
    /// @form.title("Автовоспроизведение")
    /// @form.fieldType("switch")
    autoplay Boolean @default(true)
    /// @form.title("Предпочтение дорожек")
    /// @form.fieldType("radioCard")
    /// @form.description("Какие дорожки выбирать автоматически при первом просмотре")
    trackPreference TrackPreference @default(AUTO)
    /// @form.exclude
    /// Профиль кодирования по умолчанию
    defaultProfileId String?
    defaultProfile EncodingProfile? @relation(fields: [defaultProfileId], references: [id], onDelete: SetNull)
    updatedAt DateTime @updatedAt()
}

/// Профиль кодирования
model EncodingProfile {
    id String @id() @default(cuid())
    /// @form.title("Название")
    /// @form.placeholder("Например: Blackwell UHQ")
    name String
    /// Встроенный или пользовательский
    isBuiltIn Boolean @default(false)
    /// @form.title("Профиль по умолчанию")
    /// @form.fieldType("switch")
    isDefault Boolean @default(false)
    /// @form.title("Видеокодек")
    /// @form.fieldType("radioCard")
    codec VideoCodec @default(AV1)
    /// @form.title("Использовать GPU")
    /// @form.fieldType("switch")
    useGpu Boolean @default(true)
    /// @form.title("Rate Control")
    /// @form.fieldType("radioCard")
    rateControl RateControl @default(VBR)
    /// @form.title("Качество (CQ/CRF)")
    /// @form.fieldType("slider")
    /// @form.props({ min: 15, max: 40, showValue: true })
    /// @form.description("Меньше = лучше качество, больше размер")
    cq Int @default(28)
    /// @form.title("Макс. битрейт (Mbps)")
    /// @form.fieldType("numberInput")
    /// @form.props({ min: 1, max: 100 })
    /// @form.description("Для VBR режима")
    maxBitrate Int?
    /// @form.title("Пресет скорости")
    /// @form.fieldType("select")
    /// @form.props({ options: ["p1", "p2", "p3", "p4", "p5", "p6", "p7"] })
    preset String @default("p5")
    /// @form.title("Tune")
    /// @form.fieldType("radioCard")
    tune Tune @default(HQ)
    /// @form.title("Multipass")
    /// @form.fieldType("radioCard")
    multipass Multipass @default(DISABLED)
    /// @form.title("Spatial AQ")
    /// @form.fieldType("switch")
    /// @form.description("Улучшает качество плоских областей")
    spatialAq Boolean @default(true)
    /// @form.title("Temporal AQ")
    /// @form.fieldType("switch")
    /// @form.description("Адаптирует качество для движущихся сцен")
    temporalAq Boolean @default(true)
    /// @form.title("AQ Strength")
    /// @form.fieldType("slider")
    /// @form.props({ min: 1, max: 15, showValue: true })
    aqStrength Int @default(8)
    /// @form.title("Lookahead Frames")
    /// @form.fieldType("slider")
    /// @form.props({ min: 0, max: 250, showValue: true })
    /// @form.description("Количество кадров для анализа (0 = авто)")
    lookahead Int?
    /// @form.title("Lookahead Level")
    /// @form.fieldType("slider")
    /// @form.props({ min: 0, max: 3, showValue: true })
    lookaheadLevel Int?
    /// @form.title("GOP Size")
    /// @form.fieldType("numberInput")
    /// @form.props({ min: 1, max: 600 })
    /// @form.description("Расстояние между ключевыми кадрами")
    gopSize Int @default(240)
    /// @form.title("B-Ref Mode")
    /// @form.fieldType("radioCard")
    bRefMode BRefMode @default(DISABLED)
    /// @form.title("Принудительно 10-bit")
    /// @form.fieldType("switch")
    /// @form.description("Выводить 10-bit даже для 8-bit источника")
    force10Bit Boolean @default(false)
    /// @form.title("Temporal Filter")
    /// @form.fieldType("switch")
    /// @form.description("Blackwell+ только: +4-5% качества при движении")
    temporalFilter Boolean @default(false)
    /// @form.title("Предпочитать CPU")
    /// @form.fieldType("switch")
    /// @form.description("Принудительно использовать libsvtav1 вместо NVENC")
    preferCpu Boolean @default(false)
    /// @form.title("Deband фильтр")
    /// @form.fieldType("switch")
    /// @form.description("Убирает banding в градиентах (может вызывать краши на тяжёлых файлах)")
    deband Boolean @default(true)
    settings Settings[]
    episodes Episode[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()

    @@index([isBuiltIn])
    @@index([isDefault])
}

/// Элемент очереди импорта
/// Хранит настройки из wizard'а для последовательной обработки
model ImportQueueItem {
    id String @id() @default(cuid())
    /// Статус обработки
    status ImportQueueItemStatus @default(PENDING)
    /// Приоритет (меньше = раньше)
    priority Int @default(0)
    /// Время добавления в очередь
    addedAt DateTime @default(now())
    /// Время начала обработки
    startedAt DateTime?
    /// Время завершения
    completedAt DateTime?
    /// JSON с полными данными ImportQueueEntry (folderPath, selectedAnime, files, etc.)
    dataJson String
    /// Сообщение об ошибке (если status = ERROR)
    error String?
    /// Прогресс обработки (0-100)
    progress Int @default(0)
    /// Текущий обрабатываемый файл
    currentFileName String?
    /// ID созданного аниме в БД (для отката при ошибке)
    createdAnimeId String?
    /// Путь к папке аниме в библиотеке (для отката)
    createdAnimeFolder String?

    @@index([status])
    @@index([priority])
    @@index([addedAt])
}